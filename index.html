<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Allerta Basilicata</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f6f8; margin: 0; padding-bottom: 90px; }
        .app-header { background: #003366; color: white; padding: 25px 20px 60px 20px; border-radius: 0 0 30px 30px; text-align: center; }
        .app-subtitle { font-size: 0.8rem; opacity: 1; margin-top: 8px; background: rgba(255,255,255,0.2); display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: bold; }
        .day-switch-container { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .day-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; }
        .day-btn.active { background: white; color: #003366; }
        .container { padding: 20px; max-width: 600px; margin: -40px auto 0 auto; }
        .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .risk-badge { padding: 4px 10px; border-radius: 6px; color: white; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; }
        .bg-green { background-color: #2ecc71; } .bg-yellow { background-color: #f1c40f; color: #333; } .bg-orange { background-color: #e67e22; } .bg-red { background-color: #e74c3c; }
        .fav-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="app-header">
        <h1 style="margin:0; font-size:1.5rem;">Allerta Basilicata</h1>
        <div class="app-subtitle" id="data-aggiornamento">Sincronizzazione...</div>
        <div class="day-switch-container">
            <button class="day-btn active" id="btn-oggi" onclick="setDay('oggi')">OGGI</button>
            <button class="day-btn" id="btn-domani" onclick="setDay('domani')">DOMANI</button>
        </div>
    </div>
    <div class="container">
        <div class="card"><button onclick="trovaPosizione()" id="btn-localizza" style="width:100%; padding:15px; background:#3498db; color:white; border:none; border-radius:12px; font-weight:bold;">LOCALIZZAMI ORA</button>
            <div id="gps-result" style="display:none; text-align:center; margin-top:20px;"><div id="gps-comune" style="font-size:1.5rem; font-weight:bold;"></div><div id="gps-badge" class="risk-badge" style="margin-top:10px; display:inline-block;"></div></div>
        </div>
        <div class="card"><div id="fav-list"></div><div style="display:flex; gap:10px; margin-top:15px;"><select id="comuneSelect" style="flex:1; padding:10px;"></select><button onclick="aggiungiPreferito()" style="background:#2ecc71; color:white; border:none; padding:10px 15px; border-radius:8px;">+</button></div></div>
    </div>
    <div class="bottom-nav"><a href="#" style="text-decoration:none; color:#003366; font-weight:bold; font-size:0.8rem;">Home</a><a href="mappa.html" style="text-decoration:none; color:#b0b0b0; font-size:0.8rem;">Mappa</a></div>

    <script>
        const DATA_JSON_URL = "https://eatapples15.github.io/allerte_bollettino_basilicata/dati_bollettino.json";
        const municipalityMap = {"ABRIOLA": "BASI B", "ACCETTURA": "BASI B", "ACERENZA": "BASI B", "ALBANO DI LUCANIA": "BASI B", "ALIANO": "BASI C", "ANZI": "BASI B", "ARMENTO": "BASI C", "ATELLA": "BASI A1", "AVIGLIANO": "BASI B", "BALVANO": "BASI A2", "BANZI": "BASI B", "BARAGIANO": "BASI A2", "BARILE": "BASI A1", "BELLA": "BASI A2", "BERNALDA": "BASI E2", "BRIENZA": "BASI A2", "BRINDISI MONTAGNA": "BASI B", "CALCIANO": "BASI B", "CALVELLO": "BASI B", "CALVERA": "BASI C", "CAMPOMAGGIORE": "BASI B", "CANCELLARA": "BASI B", "CARBONE": "BASI C", "CASTELGRANDE": "BASI A2", "CASTELLUCCIO INFERIORE": "BASI D", "CASTELLUCCIO SUPERIORE": "BASI D", "CASTELMEZZANO": "BASI B", "CASTELSARACENO": "BASI D", "CASTRONUOVO DI SANT ANDREA": "BASI C", "CERSOSIMO": "BASI C", "CHIAROMONTE": "BASI C", "CIRIGLIANO": "BASI C", "COLOBRARO": "BASI C", "CORLETO PERTICARA": "BASI C", "CRACO": "BASI E1", "EPISCOPIA": "BASI C", "FARDELLA": "BASI C", "FERRANDINA": "BASI B", "FILIANO": "BASI A1", "FORENZA": "BASI A1", "FRANCAVILLA IN SINNI": "BASI C", "GALLICCHIO": "BASI C", "GARAGUSO": "BASI B", "GENZANO DI LUCANIA": "BASI B", "GINESTRA": "BASI A1", "GORGOGLIONE": "BASI C", "GRASSANO": "BASI B", "GROTTOLE": "BASI B", "GRUMENTO NOVA": "BASI C", "GUARDIA PERTICARA": "BASI C", "IRSINA": "BASI B", "LAGONEGRO": "BASI D", "LATRONICO": "BASI D", "LAURENZANA": "BASI B", "LAURIA": "BASI D", "LAVELLO": "BASI A1", "MARATEA": "BASI D", "MARSICO NUOVO": "BASI C", "MARSICOVETERE": "BASI C", "MASCHITO": "BASI A1", "MATERA": "BASI B", "MELFI": "BASI A1", "MIGLIONICO": "BASI B", "MISSANELLO": "BASI C", "MOLITERNO": "BASI C", "MONTALBANO JONICO": "BASI E1", "MONTEMILONE": "BASI A1", "MONTEMURRO": "BASI C", "MONTESCAGLIOSO": "BASI E2", "MURO LUCANO": "BASI A2", "NEMOLI": "BASI D", "NOEPOLI": "BASI C", "NOVA SIRI": "BASI E1", "OLIVETO LUCANO": "BASI B", "OPPIDO LUCANO": "BASI B", "PALAZZO SAN GERVASIO": "BASI A1", "PATERNO": "BASI C", "PESCOPAGANO": "BASI A1", "PICERNO": "BASI A2", "PIETRAGALLA": "BASI B", "PIETRAPERTOSA": "BASI B", "PIGNOLA": "BASI B", "PISTICCI": "BASI E2", "POLICORO": "BASI E1", "POMARICO": "BASI B", "POTENZA": "BASI B", "RAPOLLA": "BASI A1", "RAPONE": "BASI A1", "RIONERO IN VULTURE": "BASI A1", "RIPACANDIDA": "BASI A1", "RIVELLO": "BASI D", "ROCCANOVA": "BASI C", "ROTONDA": "BASI D", "ROTONDELLA": "BASI E1", "RUOTI": "BASI A2", "RUVO DEL MONTE": "BASI A1", "SALANDRA": "BASI B", "SAN CHIRICO NUOVO": "BASI B", "SAN CHIRICO RAPARO": "BASI C", "SAN COSTANTINO ALBANESE": "BASI C", "SAN FELE": "BASI A1", "SAN GIORGIO LUCANO": "BASI C", "SAN MARTINO DAGRI": "BASI C", "SAN MAURO FORTE": "BASI B", "SAN PAOLO ALBANESE": "BASI C", "SAN SEVERINO LUCANO": "BASI C", "SANT ANGELO LE FRATTE": "BASI A2", "SANT ARCANGELO": "BASI C", "SARCONI": "BASI C", "SASSO DI CASTALDA": "BASI A2", "SATRIANO DI LUCANIA": "BASI A2", "SAVOIA DI LUCANIA": "BASI A2", "SCANZANO JONICO": "BASI E1", "SENISE": "BASI C", "SPINOSO": "BASI C", "STIGLIANO": "BASI C", "TEANA": "BASI C", "TERRANOVA DI POLLINO": "BASI C", "TITO": "BASI A2", "TOLVE": "BASI B", "TRAMUTOLA": "BASI C", "TRECCHINA": "BASI D", "TRICARICO": "BASI B", "TRIVIGNO": "BASI B", "TURSI": "BASI C", "VAGLIO BASILICATA": "BASI B", "VALSINNI": "BASI C", "VENOSA": "BASI A1", "VIETRI DI POTENZA": "BASI A2", "VIGGIANELLO": "BASI D", "VIGGIANO": "BASI C"};
        let bollettinoData = null; let jsonKey = 'oggi'; let lastGpsName = null;

        function updateUI() {
            if (!bollettinoData) return;
            const inizio = bollettinoData.validita_inizio || "N/D";
            const fine = bollettinoData.validita_fine || "N/D";
            document.getElementById('data-aggiornamento').innerText = `ValiditÃ : ${inizio} - ${fine}`;
            renderPreferiti();
            if(lastGpsName) updateGpsCard(lastGpsName);
        }

        async function initApp() {
            try {
                const res = await fetch(DATA_JSON_URL + '?t=' + Date.now());
                bollettinoData = await res.json();
                popolaSelectComuni(); setDay('oggi');
            } catch(e) { document.getElementById('data-aggiornamento').innerText = "Dati non disponibili"; }
        }

        function setDay(val) {
            jsonKey = val;
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + val).classList.add('active');
            updateUI();
        }

        function renderPreferiti() {
            const el = document.getElementById('fav-list'); const s = JSON.parse(localStorage.getItem('pc_preferiti')||'[]');
            el.innerHTML = s.length ? "" : '<p style="text-align:center;color:#ccc;">Nessun preferito.</p>';
            s.forEach(c => {
                const d = getDatiComune(c);
                el.innerHTML += `<div class="fav-item"><div><b>${c}</b><br><small>${d.zona}</small></div><div style="display:flex;gap:10px;"><span class="risk-badge ${d.bg}">${d.label}</span><i class="fas fa-trash" style="color:#ddd;" onclick="rimuoviPreferito('${c}')"></i></div></div>`;
            });
        }

        function getDatiComune(nome) {
            const zona = municipalityMap[nome.toUpperCase()];
            if(!bollettinoData || !zona) return { label: "N/D", bg: "bg-gray", zona: "?" };
            const zd = bollettinoData.zone[zona];
            const col = (typeof zd === 'string') ? zd : (zd[jsonKey] || 'green');
            const labels = { green: "ORDINARIA", yellow: "ATTENZIONE", orange: "PREALLARME", red: "ALLARME" };
            return { label: labels[col], bg: "bg-" + col, zona: zona };
        }

        function popolaSelectComuni() {
            const sel = document.getElementById('comuneSelect'); sel.innerHTML = '<option value="">Comune...</option>';
            Object.keys(municipalityMap).sort().forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });
        }

        function aggiungiPreferito() {
            const c = document.getElementById('comuneSelect').value; if(!c) return;
            let s = JSON.parse(localStorage.getItem('pc_preferiti')||'[]');
            if(!s.includes(c)) { s.push(c); localStorage.setItem('pc_preferiti', JSON.stringify(s)); updateUI(); }
        }

        function rimuoviPreferito(c) {
            let s = JSON.parse(localStorage.getItem('pc_preferiti')||'[]');
            localStorage.setItem('pc_preferiti', JSON.stringify(s.filter(x=>x!==c))); updateUI();
        }

        function trovaPosizione() {
            navigator.geolocation.getCurrentPosition((pos) => {
                // Semplificato: trova solo Potenza per test, espandi con Turf.js se GeoJSON presente
                lastGpsName = "POTENZA"; updateGpsCard("POTENZA");
                document.getElementById('gps-result').style.display = 'block';
                document.getElementById('btn-localizza').style.display = 'none';
            });
        }

        function updateGpsCard(nome) {
            const d = getDatiComune(nome);
            document.getElementById('gps-comune').innerText = nome;
            const b = document.getElementById('gps-badge');
            b.className = "risk-badge " + d.bg; b.innerText = d.label;
        }

        initApp();
    </script>
</body>
</html>
